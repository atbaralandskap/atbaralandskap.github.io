---
title: "Markanvändning i Södermanland"
format:
  html:
    theme: cosmo
    toc: true
    code-fold: true
    embed-resources: true
execute:
  echo: true
  warning: false
  message: false
---
# Diagram med ggplot
ggplot2 är ett R-paket för att skapa tydliga och flexibla datavisualiseringar baserade på det grammatiska ramverket för grafik.
girafe (från paketet ggiraph) bygger vidare på ggplot2 och gör diagrammen interaktiva, så att användaren kan hovra över element för att se information i verktygstips eller markera objekt visuellt.

Analysen visar hur mark och vatten används inom Södermanlands län, baserat på öppna kartdata från OpenStreetMap. Data har bearbetats geografiskt för att avgränsas till länets kommuner och för att klassificera ytor efter typ av markanvändning, såsom skog, jordbruksmark, bebyggelse och vatten. För varje kommun har arealer beräknats i hektar och summerats per kategori. De tio största markanvändningstyperna per kommun lyfts fram för att underlätta jämförelser. Resultatet presenteras i ett interaktivt diagram där skillnader i markanvändning och rumslig struktur mellan kommunerna tydliggörs.

```{r setup}
library(sf)
library(dplyr)
library(ggplot2)
library(ggiraph)
library(mapview)
library(scales)
library(tidytext)
library(leaflet)

layers <- readRDS("C:/Users/henri/data/processed/sormland_landuse_ready.Rds")

combined_landuse   <- layers$combined_landuse
waterways_sormland <- layers$waterways_sormland
water_sormland     <- layers$water_sormland
sormland           <- layers$sormland
```

```{r ggplot}
# ---- Aggregate for plotting ----
area_plot_data <- combined_landuse %>%
  st_drop_geometry() %>%
  group_by(kommunnamn, fclass) %>%
  summarise(total_ha = sum(area_ha, na.rm = TRUE), .groups = "drop") %>%
  mutate(fclass_reorder = reorder_within(fclass, total_ha, kommunnamn))


custom_colors <- c(
  "forest"="#2E8B57","farmland"="#F4D03F","residential"="#E67E22","industrial"="#95A5A6",
  "nature_reserve"="#27AE60","meadow"="#A9DFBF","military"="#D2B48C",
  "water"="#3498DB","wetland"="#76D7C4","other"="#D5D8DC"
)

custom_colors <- c(custom_colors, setNames(rep("#D5D8DC", 1), "other"))
fill_scale <- scale_fill_manual(values = custom_colors, na.value = "#D5D8DC")

# Add tooltip aesthetics
p <- ggplot(area_plot_data,
            aes(x = fclass_reorder,
                y = total_ha,
                fill = fclass,
                tooltip = paste0("Land use: ", fclass, "\nArea: ", round(total_ha), " ha"),
                data_id = fclass)) +
  geom_bar_interactive(stat = "identity") +
  facet_wrap(~kommunnamn, scales = "free_y") +
  coord_flip() +
  scale_x_reordered() +
  theme_minimal(base_size = 9) +  # globally smaller base font
  labs(x = "Land use type", y = "Area (ha)", fill = "Land use") +
  fill_scale +
  theme(
    strip.text = element_text(size = 8, face = "bold"),          # kommun names
    axis.text.x = element_text(size = 7, angle = 0, vjust = 1),  # numeric axis (area)
    axis.text.y = element_text(size = 7, hjust = 1),             # land use names
    axis.title.x = element_text(size = 8, face = "bold", vjust = -0.2),
    axis.title.y = element_text(size = 8, face = "bold"),
    legend.text = element_text(size = 7),
    legend.title = element_text(size = 8),
    panel.spacing = unit(0.8, "lines")                           # a little breathing room
  ) +
  scale_y_continuous(
    labels = scales::label_number(scale_cut = scales::cut_short_scale()),
    expand = expansion(mult = c(0, 0.05))  # a bit of space above bars
  )


girafe(ggobj = p,
       options = list(
         opts_hover(css = "fill-opacity:0.9;stroke:black;stroke-width:1.5px;"),
         opts_tooltip(css = "background-color:rgba(255,255,255,0.9);color:black;padding:4px;border-radius:5px;")
       ))
```

# Karta med Mapview
mapview är ett R-paket som används för att snabbt visualisera geografiska data interaktivt direkt från R.
Det bygger på leaflet och gör det möjligt att utforska rumsliga objekt — som punkter, linjer och polygoner — med zoom, lagerhantering och popup-information utan att behöva exportera till externa GIS-program.

Kartan visar den rumsliga fördelningen av olika typer av markanvändning i Södermanlands län. Underlaget bygger på sammanställda polygondata från OpenStreetMap, där varje yta har klassificerats utifrån sin funktion, till exempel skog, jordbruksmark, bebyggelse eller vatten.
Färgerna i kartan representerar respektive markanvändningskategori, och genom att klicka på ett område visas information om platsens namn, kommun och beräknad areal.
Kartan är interaktiv — användaren kan zooma, panorera och utforska hur markanvändningen varierar mellan olika delar av länet.

```{r mapview}
# ---- Mapview ----
# Ensure every fclass has a defined color
custom_colors <- c(
  "forest"="#2E8B57","farmland"="#F4D03F","residential"="#E67E22","industrial"="#95A5A6",
  "nature_reserve"="#27AE60","meadow"="#A9DFBF","military"="#D2B48C",
  "water"="#3498DB","wetland"="#76D7C4","other"="#D5D8DC",
  "scrub"="#A0522D","grass"="#C2E699","farmyard"="#F7DC6F",
  "recreation_ground"="#58D68D","quarry"="#BFC9CA"
)


combined_landuse <- combined_landuse %>%
  mutate(color = custom_colors[fclass])

used_classes <- sort(unique(combined_landuse$fclass))
used_colors  <- custom_colors[used_classes]

m_landuse <- mapview(
  combined_landuse,
  zcol = "fclass",
  col.regions = combined_landuse$color,
  lwd = 0,
  popup = combined_landuse$popup,
  alpha.regions = 0.7,
  legend = FALSE,
  layer.name = "Markanvändning"
)

m_landuse@map <- m_landuse@map %>%
  addLegend(
    "topright",
    title = "Markanvändning",
    colors = unname(used_colors),
    labels = used_classes,
    opacity = 0.9
  )

m_waterways <- mapview(waterways_sormland, zcol = "OVclass", lwd = 2,
                       legend = TRUE, popup = waterways_sormland$popup, layer.name = "Vattendrag", hide = TRUE)
m_water <- mapview(water_sormland, zcol = "fclass",
                   col.regions = c("water"="#4F9DDE","wetland"="#7FC97F"),
                   popup = water_sormland$popup, alpha.regions = 0.7, layer.name = "Vattenytor", hide = TRUE)
m_admin <- mapview(sormland, alpha.regions = 0, color = "black", lwd = 1.2, layer.name = "Kommungränser", hide = TRUE)

m_landuse + m_water + m_waterways + m_admin

```
